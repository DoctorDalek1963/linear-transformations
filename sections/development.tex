% lintrans - The linear transformation visualizer
% Copyright (C) 2021-2022 D. Dyson (DoctorDalek1963)

% This program is licensed under GNU GPLv3, available here:
% <https://www.gnu.org/licenses/gpl-3.0.html>

\documentclass[../main.tex]{subfiles}

\begin{document}

Please note, throughout this section, every code snippet will have two comments at the top. The first is the git commit hash that the snippet was taken from\footnote{A history of all commits can be found in the GitHub repository\cite{lintrans-github}}. The second comment is the file name and line numbers. If the line numbers are omitted, then the snippet is the whole file. After a certain point, I introduced copyright comments at the top of every file. These are always omitted here.

\subsection{Matrices backend\label{subsection:development:matrices-backend}}

\subsubsection{\texttt{MatrixWrapper} class}

The first real part of development was creating the \texttt{MatrixWrapper} class. It needs a simple instance dictionary to be created in the constructor, and it needs a way of accessing the matrices. I decided to use Python's \texttt{\_\_getitem\_\_} and \texttt{\_\_setitem\_\_} special methods\cite{python-3-special-methods} to allow indexing into a \texttt{MatrixWrapper} object like \texttt{wrapper['M']}. This simplifies using the class.

%: 29ec1fedbf307e3b7ca731c4a381535fec899b0b
%: src/lintrans/matrices/wrapper.py

This code is very simple. The constructor (\texttt{\_\_init\_\_}) creates a dictionary of matrices which all start out as having no value, except the identity matrix \textbf{I}. The \texttt{\_\_getitem\_\_} and \texttt{\_\_setitem\_\_} methods allow the user to easily get and set matrices just like a dictionary, and \texttt{\_\_setitem\_\_} will raise an error if the name is invalid. This is a very early prototype, so it doesn't validate the type of whatever the user is trying to assign it to yet. This validation will come later.

I could make this class subclass \texttt{dict}, since it's basically just a dictionary at this point, but I want to extend it with much more functionality later, so I chose to handle the dictionary stuff myself.

I then had to write unit tests for this class, and I chose to do all my unit tests using a framework called \texttt{pytest}.

%: 29ec1fedbf307e3b7ca731c4a381535fec899b0b
%: tests/test_matrix_wrapper.py

These tests are quite simple and just ensure that the expected behaviour works the way it should, and that the correct errors are raised when they should be. It verifies that matrices can be assigned, that every valid name works, and that the identity matrix \textbf{I} cannot be assigned to.

The function decorated with \mintinline{python}{@pytest.fixture} allows functions to use a parameter called \texttt{wrapper} and \texttt{pytest} will automatically call this function and pass it as that parameter. It just saves on code repetition.

\subsubsection{Rudimentary parsing and evaluating}

This first thing I did here was improve the \texttt{\_\_setitem\_\_} and \texttt{\_\_getitem\_\_} methods to validate input and easily get transposes and simple rotation matrices.

%: f89fc9fd8d5917d07557fc50df3331123b55ad6b
%: src/lintrans/matrices/wrapper.py:60-81

In this method, I'm now casting all the values to floats. This is very simple validation, since this cast will raise \mintinline{python}{ValueError} if it fails to cast the value to a float. I should've declared \texttt{:raises ValueError:} in the docstring, but this was an oversight at the time.

%: f89fc9fd8d5917d07557fc50df3331123b55ad6b
%: src/lintrans/matrices/wrapper.py:27-59

This \texttt{\_\_getitem\_\_} method now allows for easily accessing transposes and rotation matrices by checking input with regular expressions. This makes getting matrices easier and thus makes evaluating full expressions simpler.

The \texttt{create\_rotation\_matrix()} method is also defined in this file and just uses the $\begin{psmallmatrix}\cos\theta & -\sin\theta\\\sin\theta & \cos\theta\end{psmallmatrix}$ formula from before:

%: f89fc9fd8d5917d07557fc50df3331123b55ad6b
%: src/lintrans/matrices/wrapper.py:158-168

At this stage, I also implemented a simple parser and evaluator using regular expressions. It's not great and it's not very flexible, but it can evaluate simple expressions.

%: f89fc9fd8d5917d07557fc50df3331123b55ad6b
%: src/lintrans/matrices/wrapper.py:83-155

I think the comments in the code speak for themselves, but we basically split the expression up into groups to be added, and then for each group, we multiply every matrix in that group to get its value, and then add all these values together at the end.

This code is objectively bad. At the time of writing, it's now quite old, so I can say that. This code has no real error handling, and line 48 introduces the glaring error that \texttt{'A++B'} is now a valid expression because we disregard empty strings. Not to mention the fact that the method is called \texttt{parse\_expression} but actually evaluates an expression. All these issues will be fixed in the future, but this was the first implementation of matrix evaluation, and it does the job decently well.

I then implemented several tests for this parsing.

%: 60e0c713b244e097bab8ee0f71142b709fde1a8b
%: tests/test_matrix_wrapper_parse_expression.py

These test lots of simple expressions, but don't test any more complicated expressions, nor do they test any validation, mostly because validation doesn't really exist at this point. \texttt{'A++B'} is still a valid expression and is equivalent to \texttt{'A+B'}.

\end{document}
